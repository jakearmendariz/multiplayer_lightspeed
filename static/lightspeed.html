<!DOCTYPE html>
<html>
  <head>
    <script src="p5.min.js"></script>
    <script src="p5.dom.min.js"></script>
    <script src="//code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    <!-- <script src="../../static/js/light.js"></script> -->
    <script>

const browserId = localStorage.browserId || Math.floor(Math.random() * 10000);;
localStorage.browserId = browserId;
console.log('browserId:' + browserId)


var canvas_size = Math.min([window.innerWidth, window.innerHeight]);

var socket = null

var startTime = 0;
var counter = 0;
var gameStarted = false;

var rockets = {}
var xPos;
var yPos;
var aHeight;
var aWidth;
var direction = 0;
var explosion = false;
var explosionSize;
var astDestroyed = 0;
var hitCounter = [];
var highScore = 0;
//Increases difficulty
var speedInc = 0.2;
var gameSpeed = 0.2;
var canRestart = true;
var bullets;
var bullet;
var spaceObjects = [];
var ave;
var bigFlame = true;
var drawAsteroid;
var drawEndingScreen;
var starsX;
var starsY;
var keys;
var moving = false;



function connect() {
    disconnect()

    const { location } = window

    const proto = location.protocol.startsWith('https') ? 'wss' : 'ws'
    const wsUri = `${proto}://${location.host}/ws/`

    socket = new WebSocket(wsUri)

    socket.onopen = () => {
        console.log('Connected to ' + wsUri)
        const $id_element = document.querySelector('#id')
        $id_element.innerHTML = 'id=' + browserId
        //console.log("Window width" + window.innerWidth + " " + window.innerHeight)
        canvas_size = Math.min(window.innerWidth, window.innerHeight);
        socket.send(`/connection {"browser_id":${browserId}, "x":${canvas_size}, "y":${canvas_size}}`)
    }

    socket.onmessage = (event) => {
        // console.log("event data: " + event.data)
        var game_state = JSON.parse(event.data);
        counter = game_state["score"];
        spaceObjects = game_state["asteroids"];
        rockets = game_state["rockets"];
    }

    socket.onclose = () => {
        const $id_element = document.querySelector('#id')
        $id_element.innerHTML = 'disconnected'
        socket = null
    }
}

function disconnect() {
    if (socket) {
        log('Disconnecting...')
        socket.close()
        socket = null

        updateConnectionStatus()
    }
}

//Where to add images and fonts
function preload() {}
setup = function() {
  keys = 1;
  createCanvas(900, 900);
  background(0, 0, 0);
  ave = (width + height) / 2;
  explosionSize = 0.025 * height;
  aHeight = 0.2 * ave;
  aWidth = aHeight * (50 / 175);
  xPos = 0.5 * width - aWidth / 2;
  yPos = 0.8 * height - aHeight;
  speedInc = 0.0035 * ave;
  gameSpeed = 0.01 * ave;
  //Rocket Shots
  starsX = [];
  starsY = [];
  for (var i = 0; i < 50; i++) {
    starsX[i] = random(0, width);
    starsY[i] = random(0, height);
  }
  bullets = [];
  bullet = function(x, y) {
    this.x = x;
    this.y = y;
  };

  keyPressed = function() {
    if (!gameStarted) {
      gameStarted = true;
      startTime = millis();
      aHeight = 0.085 * ave;
      aWidth = aHeight * (50 / 175);
      xPos = 0.5 * width - aWidth / 2;
      yPos = 0.9 * height - aHeight;
      counter = 0;
    }
    if (keyCode === 32) {
      addShot();
    }
    if (keyCode == 191) {
      addShot();
    }
    if (keyCode === 37) {
      direction = 3;
      moving = true;
    }
    if (keyCode === 38) {
      direction = 0;
      moving = true;
    }
    if (keyCode === 39) {
      direction = 1;
      moving = true;
    }
    if (keyCode === 40) {
      direction = 2;
      moving = true;
    }
  };
};

function drawAst(xloc, yloc, size, num) {
  const grayvalues = 180 / num;
  const steps = size / num;
  for (let i = 20; i < num; i++) {
    fill(i * grayvalues);
    ellipse(xloc, yloc, size - i * steps, size - i * steps);
  }
}

function drawPlanet(xloc, yloc, size, num) {
  const grayvalues = 180 / num;
  const steps = size / num;
  for (let i = 20; i < num; i++) {
    fill(i * grayvalues, i * grayvalues, 255);
    ellipse(xloc, yloc, size - i * steps, size - i * steps);
  }
}

function drawSun(xloc, yloc, size, num) {
  const grayvalues = 180 / num;
  const steps = size / num;
  for (let i = 20; i < num; i++) {
    fill(
      205 + (i * i * grayvalues) / 2,
      205 + (i * grayvalues) / 2,
      i * grayvalues
    );
    ellipse(xloc, yloc, size - i * steps, size - i * steps);
  }
}

function mouseClicked() {
  addShot();
}

var up = function() {
  console.log("pls");
  direction = 3;
};

var left = function() {
  direction = 1;
};

var right = function() {
  direction = 2;
};

var down = function() {
  direction = 0;
};


var drawAllRockets = function(){
    console.log("Drawing:" + rockets.length + " rockets");
    for (index = 0; index < rockets.length; index++) { 
        console.log(rockets[index]); 
        drawThisRocket(rockets[index]['x'], rockets[index]['y'])
    } 
}

// Draws rocket at specified location
var drawRocket = function(x, y) {
  noStroke();
  if (counter % 10) {
    bigFlame = !bigFlame;
  }

  fill(220, 220, 220);
  rect(x, y, aWidth, aHeight);
  fill(200, 200, 200);
  rect(x, y, aWidth / 6, aHeight);
  fill(180, 180, 180);
  rect(x + aWidth / 3, y, (aWidth * 2) / 3, aHeight);
  fill(130, 130, 130);
  rect(x + (aWidth * 2) / 3, y, (aWidth * 1) / 3, aHeight);

  fill(160, 1, 70);
  triangle(
    x,
    y,
    x + aWidth / 2,
    y - aHeight * (7 / 16),
    x + aWidth,
    y
  );
  ellipse(x + aWidth / 2, y + aHeight * 0.01, aWidth, aHeight * 0.2);
  fill(160 + 20, 1 + 20, 70 + 20);
  triangle(
    x,
    y + aHeight,
    x - aWidth / 2,
    y + aHeight,
    x,
    y + aHeight / 4
  );
  fill(160, 1, 70);
  triangle(
    x + (3 / 2) * aWidth,
    y + aHeight,
    x + aWidth,
    y + aHeight,
    x + aWidth,
    y + aHeight / 4
  );

  triangle(
    x + aWidth / 3,
    y + aHeight,
    x + aWidth * (2 / 3),
    y + aHeight,
    x + aWidth / 2,
    y + aHeight / 4
  );

  if (bigFlame) {
    fill(255, 100, 10);
    triangle(
      x,
      y + aHeight,
      x + aWidth,
      y + aHeight,
      x + aWidth / 2,
      y + aHeight * (9 / 6)
    );
    fill(210, 230, 0);
    triangle(
      x + aWidth / 4,
      y + aHeight,
      x + aWidth - aWidth / 4,
      y + aHeight,
      x + aWidth / 2,
      y + aHeight * (8 / 6)
    );
  } else {
    fill(255, 100, 10);
    triangle(
      x,
      y + aHeight,
      x + aWidth,
      y + aHeight,
      x + aWidth / 2,
      y + aHeight * (11 / 6)
    );
    fill(210, 230, 0);
    triangle(
      x + aWidth / 4,
      y + aHeight,
      x + aWidth - aWidth / 4,
      y + aHeight,
      x + aWidth / 2,
      y + aHeight * (10 / 6)
    );
  }
};

var drawOtherRockets = function() {
    for (var key in rockets) {
        // check if the property/key is defined in the object itself, not in parent
        if (rockets.hasOwnProperty(key)) {           
            drawRocket(rockets[key].x, rockets[key].y);
        }
    }
}

var addShot = function() {
  let _x = xPos + aWidth / 2;
  let _y = yPos - aHeight * (1 / 2);
  var b = new bullet(_x, _y);
  bullets.push(b);

  socket.send(`/shot {"x":${_x}, "y":${_y}}`)
};

var displayBullets = function() {
  fill(255, 238, 0);
  for (var i = 0; i < bullets.length; i++) {
    rect(bullets[i].x, bullets[i].y, 0.0075 * height, aHeight / 5);
  }
};
//Move up continously unless they contact a asteroid
var updateBullets = function() {
  for (var i = 0; i < bullets.length; i++) {
    bullets[i].y -= gameSpeed;
  }
};

//Draws all asteroids at their updated positions. When destroyed they will be shot out of view
var drawObjects = function() {
  for (var i = 0; i < spaceObjects.length; i++) {
    if (spaceObjects[i].radius > width/7) {
      fill(255, 238, 0);
      drawSun(
        spaceObjects[i].x,
        spaceObjects[i].y,
        spaceObjects[i].radius * 1.2,
        50
      );
    } else if (spaceObjects[i].radius < width/9) {
      fill(140, 138, 140);
      drawAst(
        spaceObjects[i].x,
        spaceObjects[i].y,
        spaceObjects[i].radius * 1.2,
        50
      );
    } else {
      fill(65, 72, 163);
      drawPlanet(
        spaceObjects[i].x,
        spaceObjects[i].y,
        spaceObjects[i].radius * 1.2,
        50
      );
    }
    /*
        ellipse(
          spaceObjects[i].x,
          spaceObjects[i].y,
          spaceObjects[i].size,
          spaceObjects[i].size
        );*/

    fill(247, 244, 244);
    textSize(12);
    //text(i, spaceObjects[i].x, spaceObjects[i].y);
  }
};

//Problem here
var intersection = function() {
  var place = -1;
  var aPlace = -1;
  var bigHit = false;
  var hit = 0;
  for (var i = 0; i < spaceObjects.length; i++) {
    for (var j = 0; j < bullets.length; j++) {
      var di = dist(
        bullets[j].x,
        bullets[j].y,
        spaceObjects[i].x,
        spaceObjects[i].y
      );
      if (di < spaceObjects[i].size / 2) {
        hit++;
        place = i;
        aPlace = j;
      }
    }
    hitCounter[i] += hit;
    hit = 0;
  }
  //Depending on size it takes # of hits to destroy
  if (place !== -1) {
    if (spaceObjects[place].size < 0.1125 * width) {
      spaceObjects[place].y = -75;
      spaceObjects[place].x = random(0, width);
      hitCounter[place] = 0;
      astDestroyed++;
    } else if (
      hitCounter[place] >= 2 &&
      spaceObjects[place].size < 0.1425 * width
    ) {
      spaceObjects[place].y = -75;
      spaceObjects[place].x = random(0, width);
      hitCounter[place] = 0;
      astDestroyed++;
    } else if (hitCounter[place] >= 3) {
      spaceObjects[place].y = -75;
      spaceObjects[place].x = random(0, width);
      hitCounter[place] = 0;
      astDestroyed++;
    }
    // print("before: " + bullets.length);
    //This should be enough but sometimes it gets rid of all bullets
    bullets.splice(aPlace, 1);
    // println("after " + bullets.length);
    counter += 20;
  }
};

//leftArrow = 37 //TopArrow = 38 //rightArrow = 39 //leftArrow = 40
//= 0 north, 1= east, 2 = south, 3 = west

drawAsteroid = function(x, y, w, h) {
  stroke(2);
  fill(140, 138, 140);
  ellipse(x, y, w, h);
  fill(80, 80, 80);
  ellipse(x + w * 0.3, y + h * 0.3, w * 0.2, h * 0.2);
};

drawEndingScreen = function() {
  fill(255, 180, 0);
  textAlign(CENTER);
  textSize(0.035 * width);
  fill(0, 0, 0);
};
/**
 * updateRocket
 *
 * Depending on the direction it will increase the speed
 */
var updateRocket = function() {
  if (keyIsPressed) {
    if (moving) {
      if (direction === 0) {
        yPos -= gameSpeed;
      } else if (direction === 1) {
        xPos += gameSpeed;
      } else if (direction === 2) {
        yPos += gameSpeed;
      } else if (direction === 3) {
        xPos -= gameSpeed;
      } else {
      }
    }
  } else {
    keys = 0;
    moving = false;
  }

  if (xPos < -1 * aWidth) {
    xPos = width;
  } else if (xPos >= width + aWidth) {
    xPos = -1 * aWidth;
  }

  if (yPos + aHeight > height) {
    yPos = height - aHeight;
  } else if (yPos < 0) {
    yPos = 0;
  }
  if (gameStarted) {
     socket.send(`/rocket {"browser_id":${browserId}, "x":${round(xPos)}, "y":${round(yPos)}}`)
  }
};

// var updateObjects = function() {
//   for (var i = 0; i < spaceObjects.length; i++) {
//     spaceObjects[i].y += spaceObjects[i].speed;
//     if (spaceObjects[i].y > height * 1.15) {
//       spaceObjects[i].y = -50;
//       spaceObjects[i].x = random(0, width);
//       spaceObjects[i].size += random(-10, 15);
//     }
//     if (spaceObjects[i].size < 0.0375 * width) {
//       spaceObjects[i].size = 0.0375 * width;
//     }
//     var d = dist(
//       xPos + aWidth / 2,
//       yPos - aHeight / 2,
//       spaceObjects[i].x,
//       spaceObjects[i].y
//     );
//     if (
//       (spaceObjects[i].x > xPos &&
//         spaceObjects[i].x < xPos + 0.08 * width &&
//         spaceObjects[i].y > yPos &&
//         spaceObjects[i].y < yPos + 0.15 * height) ||
//       d < spaceObjects[i].size / 2
//     ) {
//       explosion = true;
//       startTime = millis();
//     }
//   }
//   //Adds Asteroids to increase difficulty as program continues
//   if (counter % 1000 === 0) {
//     spaceObjects.push({
//       x: random(1, width),
//       y: random(-50, -150),
//       size: random(0.0375 * width, 0.1 * width),
//       speed: random(counter / 1000, counter / 1500 + 2) + speedInc
//     });
//   }
// };

var restart = function() {
  explosionSize = 10;
  explosion = false;
  gameStarted = true;
  counter = 0;
  xPos = 0.4875 * width;
  yPos = 0.805 * height;
  bullets.splice(0);
  spaceObjects.splice(5); //Starts with 5 space objects
  astDestroyed = 0;
  for (var i = 0; i < spaceObjects.length; i++) {
    spaceObjects[i].y = random(-200, -40);
    if (spaceObjects[i].size > 0.0875 * width) {
      spaceObjects[i].size = random(0.0375 * width, 0.1 * width);
    }
  }
};

//Main method of the program
draw = function() {
  // console.log(direction);
  background(0, 0, 0);
  fill(255, 245, 92);
  var starSize = ave * 0.003;
  for (var i = 0; i < starsX.length; i++) {
    ellipse(starsX[i], starsY[i], starSize, starSize);
  }

  if (!gameStarted) {
    counter++;
    textAlign(CENTER);
    fill(255, 255, 100);
    textSize(0.1075 * width);
    textFont("Helvetica");
    textFont("Ubuntu");
    //textFont("Times new Roman");
    text("LIGHTSPEED", 0.5 * width, 0.3 * height);
    textSize(0.05 * width);
    text("Press any button to begin", 0.5 * width, 0.4 * height);

    drawRocket(xPos, yPos);
  } else if (!explosion) {
    socket.send(`/state`);
    canRestart = false;
    counter++;
    updateRocket();
    // updateObjects();
    displayBullets();
    updateBullets();
    drawRocket(xPos, yPos);
    drawOtherRockets();
    // drawAllRockets();
    drawObjects();
    intersection();
    textSize(width * 0.03);
    fill(255, 0, 0);
    text(counter, 0.9 * width, 0.08 * height);
  } else if (explosionSize < ave * 2) {
    drawRocket(xPos, yPos);
    drawObjects();
    fill(255, 180, 0);
    ellipse(xPos, yPos, explosionSize, explosionSize);
    explosionSize += 0.025 * width;
    if (explosionSize > width / 2) {
      drawEndingScreen();
    }

    if (millis() - startTime > 1500) {
      canRestart = true;
    }
    if (keyIsPressed && canRestart) {
      restart();
    }
  } else {
    background(255, 180, 0);
    drawEndingScreen();
    if (keyIsPressed) {
      restart();
    }
  }
};

    </script>
    <link
      href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap"
      rel="stylesheet"
    />

    <!-- <link rel="stylesheet" type="text/css" href="../../static/css/style.css" /> -->
    <meta charset="utf-8" />
    <title>LightSpeed</title>
  </head>
  <script>
    function norefresh() {
      return false;
    }
  </script>
  <style>
    body {
      font-family: Ubuntu;
    }
    p {
      white-space: pre;
      color: white;
    }
    a {
      color: white;
    }
    a :visited {
      color: white;
      text-decoration: none;
    }
    a :hover {
      color: white;
      text-decoration: underline;
    }
  </style>
  <body id = 'game' onload='connect()'>
    <div id="id"></div>
    </form>
  </body>
</html>
